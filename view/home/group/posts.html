<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>小组</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="/static/light7/css/light7.min.css">
    <link rel="stylesheet" href="/static/iconfont/iconfont.css">
    <style>
        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }
        .page{
            background-color: #fff;
        }
        .bar{
            height: 3rem;
            background-color: #07518f;
            border-bottom: none;
        }
        h1.title{
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 3rem;
        }
        .icon-arrow-left {
            display: inline-block;
            width: 0.9rem;
            height: 1.4rem;
            position: absolute;
            top: 0.75rem;
            z-index: 30;
        }
        .bar~.content{
            top: 3rem;
            height: calc(100% - 3rem);
            background-color: #fff;
            position: relative;
        }
        .detail{
            padding: .6rem .8rem;
            background-color: #F5F5F5;
            border-bottom: 1px solid #F9F9F9;
        }
        .group-detail{
            width: 100%;
            display: flex;
        }
        .cover, .cover img{
            display: inline-block;
            height: 3rem;
            width: 3rem;
        }
        .group-item-info{
            display: inline-block;
            flex: 1;
            margin-left: 1rem;
            position: relative;
        }
        .group-title{
            line-height: 2rem;
        }
        .members{
            line-height: 1rem;
            font-size: .7rem;
        }
        .button-container{
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: .5rem 0 0 0;
            font-size: .7rem;
            text-align: center;
        }
        .span-18{
            flex: 5
        }
        .span-13{
            flex: 3
        }
        .btn{
            font-size: .6rem;
            margin: .2rem;
            padding: .2rem .3rem;
            border-radius: .3rem;
            color: #fff;
        }
        .desc, .share{
            background-color: #0F528D;
        }
        .join, .quit{
            background: #74B941;
            border: none;
        }
        .quit{
            background-color: #A33;
        }
        .write{
            background-color: #F19725;
        }
        .detailInfo{
            width: 100%;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }
        .detailInfo .list-block{
            font-size: .7rem;
            width: 90%;
            margin: 0 auto;
            padding: .2rem 0;
            background-color: #FFF;
            border-radius: 1rem;
        }
        .list-block .item-content{
            min-height: 1rem;
            padding-left: 0;
            width: 100%;
        }
        .list-block .item-inner{
            min-height: 1rem;
            padding: .2rem 0;
            width: 100%;
            margin: 0 auto;
            border-bottom: none;
        }
        .list-block .item-title {
            width: 40%;
            text-align: right;
            padding-right: 1rem;
            color: #8C8C8C;
        }
        .list-block .item-after {
            width: 60%;
            text-align: left;
        }
        .mask{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .3);
            z-index: 10;
        }
        .btn.disabled{
            color: #8C8C8C;
            background-color: #F5F5F5;
            border: 1px solid #D5D5D5;
        }
        .post-item{
            padding: .3rem .5rem;
            border-bottom: 1px solid #DCDCDC;
        }
        .post-row{
            display: flex;
            align-items: center;
            font-size: .8rem;
        }
        .post-row.info{
            padding-left: 2rem;
            font-size: .7rem;
            position: relative;
            color: #999;
        }
        .post-comments{
            width: 1.2rem;
            margin-left: .3rem;
            margin-right: .4rem;
            font-size: .5rem;
            text-align: center;
            background-color: #6EB732;
            border-radius: .15rem;
            position: relative;
            color: #fff;
        }
        .post-comments::before{
            content: '';
            width: 0;
            height: 0;
            border-top: .5rem solid #6EB732;
            border-left: .1rem solid transparent;
            border-right: .1rem solid transparent;
            position: absolute;
            top: .7rem;
            transform: translateX(-3px) rotate(30deg);
        }
        .post-title{
            flex: 1;
        }
        .post-time{
            position: absolute;
            right: 0;
        }
    </style>
</head>
<body>
<div class="page">
    <header class="bar bar-nav">
        <h1 class="title">小组</h1>
        <a href="" class="iconfont icon-arrow-left back"></a>
    </header>
    <div class="content" id="content">
        <div class="detail">
            <div v-if="groupInfo" class="group-detail">
                <div class="cover">
                    <img :src="groupInfo.cover" alt="">
                </div>
                <div class="group-item-info">
                    <div class="group-title">{$ groupInfo.title $}</div>
                    <div class="members">成员数：{$ groupInfo.members $}</div>
                </div>
            </div>
            <div class="button-container">
                <div class="span-18">
                    <div class="btn desc" @click="showDetail">小组简介</div>
                </div>
                <div class="span-13">
                    <div class="btn share">分享</div>
                </div>
                <div class="span-18">
                    <button :class="'btn join ' + (groupInfo.userInThisGroup ? 'disabled' : '')" :disabled="groupInfo.userInThisGroup ? true : false"  @click="joinGroup">加入小组</button>
                </div>
                <div class="span-18">
                    <button :class="'btn quit ' + (groupInfo.userInThisGroup ? '' : 'disabled')" :disabled="groupInfo.userInThisGroup ? false : true" @click="quitGroup">退出小组</button>
                </div>
                <div class="span-18">
                    <div class="btn write" @click="toPost">发帖</div>
                </div>
            </div>
        </div>
        <div class="post-list">
            <div class="post-item" v-for="post in posts">
                <div class="post-row">
                    <div class="post-comments">{$ post.comments $}</div>
                    <div class="post-title">{$ post.title $}</div>
                </div>
                <div class="post-row info">
                    <div class="post-avatar" v-if="post.authorAvatar">{$ post.authorAvatar $}</div>
                    <div class="post-name">{$ post.authorName $}</div>
                    <div class="post-time">{$ new Date(post.updateTime).Format('yyyy-MM-dd hh:mm') $}</div>
                </div>
            </div>
        </div>
        <div class="detailInfo" v-if="groupDetailShow">
            <div class="list-block">
                <div class="item-content" v-for="item in detailList" v-if="groupInfo[item.en]">
                    <div class="item-inner">
                        <div class="item-title">{$ item.item $}</div>
                        <div class="item-after">{$ groupInfo[item.en] $}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mask" v-if="groupDetailShow" @click="hideDetail"></div>
    </div>
</div>


<script type="text/javascript " src="/static/vue/vue.js "></script>
<script type='text/javascript' src='/static/js/jquery.js' charset='utf-8'></script>
<script type='text/javascript' src='/static/light7/js/light7.min.js' charset='utf-8'></script>
<script>
    $.init()

    new Vue({
        delimiters: ['{$', '$}'],
        data () {
        	return {
        		groupInfo: {},
                posts: undefined,
		        groupDetailShow: false,
                joinDisabled: false,
                quitDisabled: false,
                detailList: [{
        			item: '类型',
                    en: 'groupType'
                }, {
	                item: '创建人',
	                en: 'creatorName'
                }, {
	                item: '创建时间',
	                en: 'createTime'
                }, {
	                item: '简介',
	                en: 'description'
                }, {
	                item: '成员数',
	                en: 'members'
                }, {
	                item: '活动时间',
	                en: 'activityTime'
                }, {
	                item: '活动地点',
	                en: 'place'
                }, {
	                item: '乐园',
	                en: 'park'
                }, {
	                item: '设备',
	                en: 'facility'
                }, {
	                item: '备注',
	                en: 'remark'
                }]
            }
        },
        created: function () {
        	let self = this
            $.ajax({
                url: '/group/getgroupinfo',
                data: {
                	id: "{{ id }}"
                },
                success: function (ret) {
                    self.groupInfo = ret.data
                    self.groupInfo.createTime = new Date(self.groupInfo.createTime).Format("yyyy-MM-dd")
                    self.getPosts()
                }
            })
        },
        methods: {
        	getPosts: function () {
                let self = this
                $.ajax({
                    url: '/group/getposts',
                    data: {
                    	id: "{{ id }}"
                    },
                    success: function (ret) {
                        self.posts = ret.data.data.sort((a, b) => {
	                        return new Date(b.updateTime).getTime() - new Date(a.updateTime).getTime()
                        })
                    }
                })
	        },
        	showDetail: function () {
                this.groupDetailShow = !this.groupDetailShow
	        },
            hideDetail: function () {
	            this.groupDetailShow = !this.groupDetailShow
            },
            toPost: function () {
        		if(/uid/.test(document.cookie)) {
			        window.location.href="/group/" +this.groupInfo.id+ "/post"
                } else {
        			$.toast('您需要登录才能进行发帖')
                    setTimeout(function () {
                        window.location.href = '/user/login'
                    }, 1000)
                }
            },
            joinGroup: function () {
	            if(!/uid/.test(document.cookie)) {
		            $.toast('您需要登录才能加入小组')
		            setTimeout(function () {
			            window.location.href = '/user/login'
		            }, 1000)
                    return
	            }
                let self = this
                $.ajax({
                    url: '/group/joingroup',
	                method: 'POST',
	                data: {
		                groupId: self.groupInfo.id
	                },
                    success: function (ret) {
                        if(ret.errno === 0) {
	                        window.location.href = window.location.href
                        }
                    }
                })
            },
            quitGroup: function () {
        		let self = this
                $.ajax({
                    url: '/group/quitgroup',
                    method: 'POST',
                    data: {
                    	groupId: self.groupInfo.id
                    },
                    success: function (ret) {
                        window.location.href = window.location.href
                    }
                })
            }
        }
    }).$mount('#content')

    Date.prototype.Format = function (fmt) {
	    var o = {
		    "M+": this.getMonth() + 1, //月份
		    "d+": this.getDate(), //日
		    "h+": this.getHours(), //小时
		    "m+": this.getMinutes(), //分
		    "s+": this.getSeconds(), //秒
		    "q+": Math.floor((this.getMonth() + 3) / 3), //季度
		    "S": this.getMilliseconds() //毫秒
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
		    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
    }
</script>
</body>
</html>
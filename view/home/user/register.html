<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>欢乐冶</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="/static/light7/css/light7.min.css">
    <link rel="stylesheet" href="/static/light7/css/light7-swiper.min.css">
    <link rel="stylesheet" href="/static/css/articleDetail.css">
    <link rel="stylesheet" href="/static/share/css/share.min.css">
    <link rel="stylesheet" href="/static/iconfont/iconfont.css">
</head>
<body>
<div class="page-group">
    <div class="page page-current">
        <header class="bar bar-nav">
            <a class=" iconfont icon-arrow-left back ">
            </a>
            <h1 class="title">注册</h1>
        </header>
        <div class="content center" id="rg">
            <h1 class="center">欢迎加入欢乐冶</h1>
            <div class="item-input">
                <input type="number" class="phone" @input="getValue" placeholder="手机号">
            </div>
            <div class="item-input">
                <input type="number" class="code" @input="getCode" placeholder="验证码">
                <button :class="'rt-code button button-small ' + codeButtonClass" :disabled="codeButtonIsDisabled" @click="retryAfter">{$ codetext $}</button>
            </div>
            <div>点击下一步代表您已阅读并同意<a href="/user/agreement.html">用户使用协议</a></div>
            <button :class="'button button-big ' + submitClass" :disabled="submitDisabled" @click="verifyCode">下一步</button>
        </div>
    </div>
</div>
<script type="text/javascript " src="/static/vue/vue.js "></script>
<script type='text/javascript' src='/static/js/jquery.js' charset='utf-8'></script>
<script type='text/javascript' src='/static/light7/js/light7.min.js' charset='utf-8'></script>
<script type='text/javascript' src='/static/light7/js/light7-swiper.min.js' charset='utf-8'></script>
<script type="text/javascript" src="/static/share/js/jquery.share.min.js"></script>
<script type="text/javascript" src="/static/js/clipboard.min.js"></script>
<script>
    $.init();

    let vm = new Vue({
        delimiters: ['{$', '$}'],
        el: '#rg',
        data: {
            codetext: '获取验证码',
            codeButtonClass: '',
            codeButtonIsDisabled: false,
            submitClass: 'disabled',
            submitDisabled: true
        },
        methods: {
            getValue: function (e) {
                this.value = e.currentTarget.value
            },
            getCode: function (e) {
                this.code = e.currentTarget.value
                if ((/\d{6}/).test(this.code)) {
                	this.submitClass = ''
                    this.submitDisabled = false
                }
            },
            retryAfter: function () {
                let _this = this
                if((/^1[34578]\d{9}$/).test(_this.value)){
                    _this.codeButtonIsDisabled = 'true'
                    _this.codeButtonClass = 'disabled'
                    $.toast("验证码已发送")
                    let i = 60
                    let interval = setInterval(function () {
                        i --
                        _this.codetext = i + '秒后重试'
                        if(i == 0){
                            clearInterval(interval)
                            _this.codeButtonIsDisabled = false
                            _this.codeButtonClass = ''
                            _this.codetext = '获取验证码'
                        }
                    }, 1000)
                    $.ajax({
                        url: '/user/getvfcode',
                        data: {
                            phone: _this.value
                        },
                        method: 'POST'
                    })
                    .success(function (ret) {
                    	console.log(ret)
                    })
                    .error(function (err) {
                        console.log('err', err)
                    })
                    .complete(function () {
                        console.log('done')
                    })
                } else {
                    $.toast('手机号格式不正确，请重新输入')
                }
            },
            verifyCode: function () {
                $.ajax({
                    url: '/user/verifycode',
                    data: {
                    	code: this.code
                    }
                })
                .success(function (res) {
                	console.log(res)
                	if(res.errno != 0){
		                $.toast('验证码错误，请重新输入')
                    } else {
                		window.location.href = "/user/password"
                    }
                })
                .error(function (err) {
                	console.log(err)
                    $.toast('出了点小问题，点击重试')
                })
                .complete(function (res) {
                    console.log(res)
                })
            }
        }
    })
</script>
</body>
</html>
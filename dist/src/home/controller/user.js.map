{"version":3,"sources":["../../../../src/home/controller/user.js"],"names":["checkLogin","assign","cookie","display","redirect","uid","userModel","model","articleModel","getLikes","likeArticleIdsRowData","likeArticleIds","JSON","parse","likes","getLikeArticles","likeArticles","success","articleid","post","console","log","updateLikes","parseInt","lines","account","code","generateVerificationCode","session","Number","sessionCode","fail","errors","phone","nickname","psd","ck","generateUid","register","data","logIntoSystem","loginRes","isEmpty","think","getUserInfo","userInfo","getUserDetail","userDetail","avatarCropped","avatarBase64","split","avatarBinary","Buffer","toString","userRowData","basePath","config","detailPath","id","writeFileSync","err","avatar","gender","birth","mail","introduction","city","updateUserDetail","updateRes","resetPassword"],"mappings":"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","file":"user.js","sourcesContent":["import base from './base.js';\nimport fs from 'fs';\nexport default class extends base {\n    indexAction() {\n        if (checkLogin(this)) {\n            this.assign('uid', this.cookie('uid'))\n            return this.display('user/index.html');\n        } else {\n            return this.redirect('/user/login')\n        }\n    }\n\n    agreementAction() {\n        return this.display('user/agreement.html')\n    }\n\n    likeAction() {\n        return this.display('user/like.html');\n    }\n\n    async getlikesAction() {\n        let uid = this.cookie('uid');\n        let userModel = this.model('user');\n        let articleModel = this.model('article');\n        let likeArticleIdsRowData = await userModel.getLikes(uid);\n\n        let likeArticleIds = JSON.parse(likeArticleIdsRowData[0].likes);\n        let likeArticles = await articleModel.getLikeArticles(likeArticleIds);\n        return this.success(likeArticles);\n    }\n\n    async canclelikeAction() {\n        let articleid = this.post('articleid');\n        console.log(articleid);\n        let uid = this.cookie('uid');\n        let userModel = this.model('user');\n        let lines = await userModel.updateLikes(parseInt(articleid),uid);\n        return this.success(lines);\n    }\n\n    registerAction() {\n        return this.display('user/register.html')\n    }\n\n    async getvfcodeAction() {\n        try {\n\n            let account = this.post('account')\n            let code = generateVerificationCode();\n            // let userModel = this.model('user')\n            // let send_res = await userModel.sendMessage(phone, code)\n\n            await this.session('account', account);\n            await this.session('code', Number(code));\n\n\n            let sessionCode = await this.session('code')\n            console.log(sessionCode)\n\n            return this.success(true)\n            // this.success(send_res)\n\n        } catch (err) {\n            return this.fail(err, this.errors())\n        }\n    }\n\n    async verifycodeAction() {\n        return this.success('successfully verified')\n    }\n\n    async passwordAction() {\n        if (checkLogin(this)) {\n            return this.redirect('index')\n        } else {\n            return this.display('user/password.html')\n        }\n    }\n\n    async registerinAction() {\n        try {\n            let phone = await this.session('account'),\n                nickname = this.post('nickname'),\n                psd = this.post('psd')\n            let userModel = this.model('user')\n            let ck = generateUid()\n            let data = await userModel.register(phone, nickname, psd, ck)\n\n            this.cookie('uid', ck)\n            console.log(data)\n\n            return this.success(data)\n        } catch (err) {\n            return this.fail(err)\n        }\n    }\n\n    async loginAction() {\n        let uid = this.cookie('uid')\n        if (uid) {\n            return this.redirect('/user/index')\n        }\n        return this.display('user/login.html')\n    }\n\n    async logintosystemAction() {\n        let account = this.post('account')\n        let psd = this.post('psd')\n        let userModel = this.model('user')\n\n        let ck = generateUid()\n        let loginRes = await userModel.logIntoSystem(account, psd, ck)\n\n        let isEmpty = think.isEmpty(loginRes)\n\n        console.log(isEmpty)\n\n        if (!isEmpty) {\n            this.cookie('uid', ck)\n            return this.success(loginRes)\n        } else {\n            return this.fail('login error')\n        }\n    }\n\n    async getuserinfoAction() {\n        try {\n            let uid = this.cookie('uid')\n            let userModel = this.model('user')\n            let userInfo = await userModel.getUserInfo(uid)\n            console.log(userInfo)\n            if (!think.isEmpty(userInfo)) {\n                return this.success(userInfo)\n            } else {\n                await this.cookie('uid', null)\n                return this.fail('invalid uid')\n            }\n        } catch (err) {\n            await this.cookie('uid', null)\n            return this.fail('invalid uid')\n        }\n    }\n\n    async detailAction() {\n        return this.display('user/detail.html')\n    }\n\n    async getuserdetailAction() {\n        let uid = this.cookie('uid')\n        let userModel = this.model('user')\n        let userDetail = await userModel.getUserDetail(uid)\n        if (!think.isEmpty(userDetail)) {\n            return this.success(userDetail)\n        } else {\n            this.cookie('uid', null)\n            return this.fail('invalid uid')\n        }\n    }\n\n    async editAction() {\n        return this.display('user/edit.html')\n    }\n\n    async updateuserdetailAction() {\n        let avatarCropped = this.post('avatarCropped');\n        let avatarBase64 = avatarCropped.split(',')[1];\n        let avatarBinary = new Buffer(avatarBase64, 'base64').toString('binary');\n        let userModel = this.model('user');\n        let uid = this.cookie('uid')\n        let userRowData = await userModel.getUserInfo(uid);\n        let basePath = this.config('avatarBasePath');\n        let detailPath = '/avatar/' + userRowData.id + '.png';\n        fs.writeFileSync(basePath + detailPath, avatarBinary, 'binary', function (err) {\n            console.log(err);\n        });\n        let userDetail = {\n            nickname: this.post('nickname'),\n            avatar: detailPath,\n            gender: this.post('gender'),\n            birth: this.post('birth'),\n            mail: this.post('mail'),\n            introduction: this.post('introduction'),\n            city: this.post('city')\n        }\n        console.log(userDetail)\n\n\n        let updateRes = await userModel.updateUserDetail(userDetail, uid)\n        if (!think.isEmpty(updateRes)) {\n            return this.success('successfully update')\n        } else {\n            return this.fail('update failed')\n        }\n    }\n\n    async verifyAction() {\n        return this.display('user/verify.html')\n    }\n\n    async resetAction() {\n        console.log(await this.session('account'))\n        console.log(await this.session('reset'))\n        return this.display('user/reset.html')\n    }\n\n    async resetpasswordAction() {\n        let account = await this.session('account')\n        let psd = this.post('psd')\n        let userModel = this.model('user')\n        let updateRes = await userModel.resetPassword(account, psd)\n        await this.session('reset', false)\n        if (!think.isEmpty(updateRes)) {\n            return this.success('successfully update')\n        } else {\n            return this.fail('update failed')\n        }\n    }\n}"]}
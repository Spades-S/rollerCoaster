{"version":3,"sources":["../../../../src/home/model/user.js"],"names":["args","tableName","articleid","field","where","id","select","data","newLikes","likes","likedata","Array","push","oldLikes","JSON","parse","index","indexOf","splice","update","lines","phone","code","url","method","form","apikey","mobile","text","send_res","nickname","psd","uid","sha1","createHash","newPsd","digest","add","password","phoneNumber","account","ck","psdencrypted","res","test","find","userInfo","userDetail","detail","avatar","gender","birth","mail","city","introduction","updateRes","think","isEmpty","nickName","model","base"],"mappings":"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","file":"user.js","sourcesContent":["'use strict'\n\nimport rp from 'request-promise'\nimport crypto from 'crypto'\n\nexport default class extends think.model.base {\n    init(...args) {\n        super.init(...args);\n        this.tableName = 'user';\n    }\n\n    async updateLikes(articleid) {\n        let data = await this.field('likes').where({id: 1}).select();\n        let newLikes;\n        if (data[0].likes == \"\") {\n            let likedata = new Array();\n            likedata.push(articleid);\n            newLikes = JSON.stringify(likedata);\n        } else {\n            let oldLikes = JSON.parse(data[0].likes);\n            let index = oldLikes.indexOf(articleid);\n            if (index >= 0) {\n                oldLikes.splice(index, 1);\n            } else {\n                oldLikes.push(articleid);\n            }\n            newLikes = JSON.stringify(oldLikes);\n        }\n        let lines = await this.where({id: 1}).update({likes: newLikes});\n        return lines;\n    }\n\n    async getLikes() {\n        let data = await this.field('likes').where({id: 1}).select();\n        return data;\n    }\n\n    async getAvatarInfoByUserId(id) {\n        let data = await this.field('avatar, nickname').where({id: id}).select();\n        return data;\n    }\n\n    async sendMessage(phone, code) {\n        try {\n            let send_res = await rp({\n                url: 'https://sms.yunpian.com/v2/sms/single_send.json',\n                method: 'POST',\n                form: {\n                    apikey: 'dbbbda824548a83c9976e721ddbf4cb8',\n                    mobile: phone,\n                    text: code + '(欢乐冶手机验证码，请完成验证)，如非本人操作，请忽略本短信'\n                }\n            })\n            return send_res\n        } catch (err) {\n            return err\n        }\n    }\n\n    async register(phone, nickname, psd, uid) {\n        let sha1 = crypto.createHash('sha1')\n        sha1.update(psd)\n        let newPsd = sha1.digest('hex')\n        let id = await this.add({\n            nickname: nickname,\n            password: newPsd,\n            phoneNumber: phone,\n            uid: uid\n        })\n        return id\n    }\n\n    async logIntoSystem(account, psd, ck) {\n        let sha1 = crypto.createHash('sha1')\n        sha1.update(psd)\n        let psdencrypted = sha1.digest('hex')\n        let res\n        if ((/^\\d{11}$/).test(account)) {\n            res = await this.where({phoneNumber: account, password: psdencrypted}).update({uid: ck})\n        } else {\n            res = await this.where({nickname: account, password: psdencrypted}).update({uid: ck})\n        }\n        return res\n    }\n\n    async getUserInfo(uid) {\n        let userInfo = await this.field('id,nickname, avatar').where({uid: uid}).find()\n        return userInfo\n    }\n\n    async getUserDetail(uid) {\n        let userDetail = await this.field('nickname, avatar, gender, birth, mail, city, introduction').where({uid: uid}).find()\n        return userDetail\n    }\n\n    async updateUserDetail(detail, uid) {\n        let updateRes = await this.where({uid: uid}).update({\n            nickname: detail.nickname,\n            avatar: detail.avatar,\n            gender: detail.gender,\n            birth: detail.birth,\n            mail: detail.mail,\n            city: detail.city,\n            introduction: detail.introduction\n        })\n        return updateRes\n    }\n\n    async resetPassword(account, psd) {\n        let sha1 = crypto.createHash('sha1')\n        sha1.update(psd)\n        let newPsd = sha1.digest('hex')\n        let updateRes = await this.where({phoneNumber: account}).update({password: newPsd})\n        return updateRes\n    }\n\n    async isPhoneNumExist(account) {\n        let res = await this.where({phoneNumber: account}).find()\n\n        if (think.isEmpty(res)) {\n\n            return false\n        } else {\n\n            return true\n        }\n    }\n    async isNickNameExist(nickName){\n        let res = await this.where({nickname: account}).find()\n\n        if (think.isEmpty(res)) {\n\n            return false\n        } else {\n\n            return true\n        }\n    }\n}\n"]}